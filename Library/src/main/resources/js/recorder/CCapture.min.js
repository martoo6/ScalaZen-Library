(function(){function b(){var a={};this.on=function(o,b){a[o]=b};this.emit=function(o){var b=a[o];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}}function k(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new Whammy.Video(a.framerate,a.quality)}function e(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,b){var e=
this.callback;e&&(this.callback=void 0,e(a,b))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",function(a){alert(JSON.stringify(a,null,2))}.bind(this))}function l(a){b.call(this);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.settings=a;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,
workerScript:a.workersPath+"gif.worker.js"});this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var b=this.callback;b&&(this.callback=void 0,b(URL.createObjectURL(a)))}.bind(this))}var A=window.Date.now();b.start=function(){};b.stop=function(){};b.add=function(){};b.save=function(){};b.safeToProceed=function(){return!0};k.prototype=Object.create(b);k.prototype.add=function(a){this.encoder.add(a)};k.prototype.save=
function(a){var b=this.encoder.compile(),b=new Blob([b],{type:"octet/stream"}),b=window.URL.createObjectURL(b);a(b)};e.prototype=Object.create(b);e.prototype.start=function(){this.encoder.start(this.settings)};e.prototype.add=function(a){this.encoder.add(a)};e.prototype.save=function(a){this.callback=a;this.encoder.end()};e.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};l.prototype=Object.create(b);l.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",
a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step})};l.prototype.save=function(a){this.callback=a;this.encoder.render()};window.CCapture=function(a){function b(){m||(m=!0,s(r,10))}function z(){function a(){this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime,this.pause(),t.push(this));return this._hookedTime}h("Capturer start");
d=window.Date.now();n=window.performance.now();window.Date.prototype.getTime=function(){return d};window.Date.now=function(){return d};window.setTimeout=function(a,j){var c={callback:a,time:j,triggerTime:d+j};f.push(c);h("Timeout set to "+c.time);b();return c};window.clearTimeout=function(a){for(var b=0;b<f.length;b++)f[b]==a&&(f.splice(b,1),h("Timeout cleared"))};window.setInterval=function(a,j){var c={callback:a,time:j,triggerTime:d+j};i.push(c);h("Interval set to "+c.time);b();return c};window.requestAnimationFrame=
function(a){p=a;b()};window.performance.now=function(){return n};Object.defineProperty(HTMLVideoElement.prototype,"currentTime",{get:a});Object.defineProperty(HTMLAudioElement.prototype,"currentTime",{get:a})}function r(){if(m&&g.safeToProceed()){m=!1;d+=c.step;n+=c.step;t.forEach(function(a){a._hookedTime+=c.step});u++;h("Frame: "+u);for(var a=0;a<f.length;a++)d>=f[a].triggerTime&&(f[a].callback(),console.log("timeout!"),f.splice(a,1));for(a=0;a<i.length;a++)d>=i[a].triggerTime&&(i[a].callback(),
i[a].triggerTime+=i[a].time,console.log("interval!"));if(a=p)p=null,a(d-A)}}function h(a){v&&console.log(a)}function B(a){var b=w[a];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}var c=a||{},v,d,n,g,f=[],i=[],u=0,p=null,q=!1,m=!1,w={};c.framerate=c.framerate||60;v=c.verbose||!1;c.step=1E3/c.framerate;h("Step is set to "+c.step+"ms");var a={gif:l,webm:k,ffmpegserver:e},x=a[c.format];if(!x)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");g=new x(c);
g.on("process",r);g.on("progress",function(a){B("progess",a)});!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var y=Date.now();performance.timing&&performance.timing.navigationStart&&(y=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-y}}var s=window.setTimeout,C=window.setInterval,D=window.clearTimeout,E=window.requestAnimationFrame,F=window.Date.now,G=window.performance.now,
H=window.Date.prototype.getTime,t=[];return{start:function(){z();g.start();q=!0},capture:function(a){q&&g.add(a)},stop:function(){q=!1;g.stop();h("Capturer stop");window.setTimeout=s;window.setInterval=C;window.clearTimeout=D;window.requestAnimationFrame=E;window.Date.prototype.getTime=H;window.Date.now=F;window.performance.now=G},save:function(a){g.save(a)},on:function(a,b){w[a]=b}}}})();
